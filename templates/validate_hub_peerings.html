{% extends "base.html" %}

{% block title %}Peerings Validator{% endblock %}

{% block header %}Peerings Validator{% endblock %}

{% block content %}
    <div class="card mb-4 bg-white border shadow-sm">
        <div class="card-body">
            <h5 class="card-title text-primary">What is the Peerings page?</h5>
            <p class="card-text">The Peerings page helps you validate and review VNet peerings in your Azure environment. Use this page to check connectivity, gateway transit, and access settings between your VNets, ensuring secure and efficient network communication.</p>
        </div>
    </div>
    <form method="post" class="mb-4">
        <div class="mb-3">
            <label for="subscription_id" class="form-label">Subscription:</label>
            <select name="subscription_id" id="subscription_id" class="form-select" required>
                <option value="">-- Select subscription --</option>
                {% for sub in subscriptions %}
                <option value="{{ sub.id }}" {% if selected_subscription and selected_subscription == sub.id %}selected{% endif %}>{{ sub.name }} ({{ sub.id }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label for="vnet_name" class="form-label">VNet Name:</label>
            <select name="vnet_name" id="vnet_name" class="form-select" required>
                <option value="">-- Select VNet --</option>
                {% for v in vnets %}
                <option value="{{ v.name }}" data-subscription="{{ v.subscription_id }}" {% if selected_vnet and selected_vnet == v.name %}selected{% endif %}>{{ v.name }} {% if v.resource_group_name %} ({{ v.resource_group_name }}){% endif %}</option>
                {% endfor %}
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label me-3">Role:</label>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="role" id="role_hub" value="hub" {% if is_hub %}checked{% endif %}>
                <label class="form-check-label" for="role_hub">Hub</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="role" id="role_spoke" value="spoke" {% if is_spoke %}checked{% endif %}>
                <label class="form-check-label" for="role_spoke">Spoke</label>
            </div>
        </div>
        <button type="submit" class="btn btn-dark">Submit</button>
        <a href="/" class="btn btn-secondary">Back</a>
    </form>

    {% if results %}
    <table class="table table-dark table-bordered table-hover">
        <thead>
            <tr>
                <th>Peering Name</th>
                <th>Allow VNet Access <br><small>(Must be true in both hub and spoke)</small></th>
                <th>Forwarded Traffic Allowed <br><small>(Must be true in spoke and false in hub)</small></th>
                <th>Gateway Transit Allowed <br><small>(Must be false in spoke and true in hub)</small></th>
                <th>Uses Remote Gateway <br><small>(Must be true in spoke and false in hub)</small></th>
                <th>Remote Virtual Network</th>
            </tr>
        </thead>
        <tbody>
            {% for result in results %}
            <tr>
                <td>{{ result['peering_name'] }}</td>
                {% if is_hub or is_spoke %}
                    <td style="color: {{ 'green' if result['allow_vnet_access'] else 'red' }}">{{ result['allow_vnet_access'] }}</td>
                    <td style="color: {{ 'green' if (result['allow_forwarded_traffic'] and is_spoke) or (not result['allow_forwarded_traffic'] and is_hub) else 'red' }}">{{ result['allow_forwarded_traffic'] }}</td>
                    <td style="color: {{ 'green' if (result['allow_gateway_transit'] and is_hub) or (not result['allow_gateway_transit'] and is_spoke) else 'red' }}">{{ result['allow_gateway_transit'] }}</td>
                    <td style="color: {{ 'green' if (result['use_remote_gateways'] and is_spoke) or (not result['use_remote_gateways'] and is_hub) else 'red' }}">{{ result['use_remote_gateways'] }}</td>
                {% else %}
                    <td>{{ result['allow_vnet_access'] }}</td>
                    <td>{{ result['allow_forwarded_traffic'] }}</td>
                    <td>{{ result['allow_gateway_transit'] }}</td>
                    <td>{{ result['use_remote_gateways'] }}</td>
                {% endif %}
                <td>{{ result['remote_virtual_network'] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
    <script>
        // Filter the VNet select options based on selected subscription
        document.addEventListener('DOMContentLoaded', function () {
            const subSelect = document.getElementById('subscription_id');
            const vnetSelect = document.getElementById('vnet_name');

            function filterVnets() {
                const sub = subSelect.value;
                for (const opt of Array.from(vnetSelect.options)) {
                    const optSub = opt.getAttribute('data-subscription') || '';
                    if (!opt.value) { // keep the placeholder
                        opt.style.display = '';
                        opt.disabled = false;
                        continue;
                    }
                    if (!sub || optSub === sub) {
                        opt.style.display = '';
                        opt.disabled = false;
                    } else {
                        opt.style.display = 'none';
                        opt.disabled = true;
                    }
                }

                // Collect visible (enabled) options excluding placeholder
                const visibleOptions = Array.from(vnetSelect.options).filter(o => o.value && !o.disabled);

                // If the currently selected vnet is hidden or empty, try to auto-select a candidate
                if (!vnetSelect.value || vnetSelect.selectedOptions.length === 0 || vnetSelect.selectedOptions[0].disabled) {
                    if (visibleOptions.length === 1) {
                        // Only one candidate — auto-select it
                        vnetSelect.value = visibleOptions[0].value;
                    } else {
                        // Multiple or zero candidates — reset to placeholder
                        vnetSelect.value = '';
                    }
                }
            }

            subSelect.addEventListener('change', filterVnets);
            // initialize on load
            filterVnets();
        });
    </script>
{% endblock %}